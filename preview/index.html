<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <title>Превʼю | UGCC Lausanne</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Site CSS: match production order for consistent look -->
    <link rel="stylesheet" href="../assets/css/purged/variables.css" />
    <link rel="stylesheet" href="../assets/css/purged/fonts.css" />
    <link rel="stylesheet" href="../assets/css/purged/layout.css" />
    <link rel="stylesheet" href="../assets/css/purged/header.css" />
    <link rel="stylesheet" href="../assets/css/purged/page-hero.css" />
    <link rel="stylesheet" href="../assets/css/purged/cards.css" />
    <link rel="stylesheet" href="../assets/css/purged/styles.css" />
    <link rel="stylesheet" href="../assets/css/purged/footer.css" />
    <link rel="stylesheet" href="../assets/css/purged/overrides.css" />
  </head>
  <body>
    <main id="app" style="max-width:800px;margin:24px auto;padding:16px"></main>
    <script type="module">
      import {createClient} from 'https://esm.sh/@sanity/client@7'
      import {toHTML} from 'https://esm.sh/@portabletext/to-html@2'
      import imageUrlBuilder from 'https://esm.sh/@sanity/image-url@1'

      const params = new URLSearchParams(location.search)
      const type = params.get('type')
      const rawId = params.get('id')
      const id = (rawId || '').replace(/^drafts\./, '')

      const client = createClient({
        projectId: 'y4j9iov2',
        dataset: 'production',
        apiVersion: '2024-01-01',
        useCdn: true,
        perspective: 'published'
      })
      const builder = imageUrlBuilder(client)
      const app = document.getElementById('app')

      if (!type || !id) {
        app.innerHTML = '<p>Відсутні параметри type або id.</p>'
      } else {
        render(type, id)
      }

      async function render(type, id) {
        try {
          if (type === 'article') {
            const doc = await client.fetch('*[_type == "article" && _id == $id][0]{..., image{..., asset->}}', {id})
            if (!doc) return notFound()
            app.innerHTML = articleHtml(doc)
          } else if (type === 'schedule') {
            const doc = await client.fetch('*[_type == "schedule" && _id == $id][0]', {id})
            if (!doc) return notFound()
            app.innerHTML = scheduleHtml(doc)
          } else {
            app.innerHTML = '<p>Невідомий тип документа.</p>'
          }
        } catch (e) {
          console.error(e)
          app.innerHTML = '<p>Помилка завантаження превʼю.</p>'
        }
      }

      function notFound() {
        app.innerHTML = '<p>Документ не знайдено або не опублікований.</p>'
      }

      function articleHtml(d) {
        const img = d?.image ? builder.image(d.image).width(1200).url() : null
        const content = Array.isArray(d.content) ? toHTML(d.content) : ''
        return `
          <article>
            <h1>${escapeHtml(d.title || '')}</h1>
            <p style="color:#666">${label(d.category)} • ${d.language || ''}</p>
            ${d.excerpt ? `<p>${escapeHtml(d.excerpt)}</p>` : ''}
            ${img ? `<p><img src="${img}" alt="" style="max-width:100%;height:auto;border-radius:8px"/></p>` : ''}
            <div>${content}</div>
            ${d.author ? `<p><strong>Автор:</strong> ${escapeHtml(d.author)}</p>` : ''}
          </article>
        `
      }

      function scheduleHtml(d) {
        return `
          <section>
            <h1>${escapeHtml(d.title || '')}</h1>
            <p style="color:#666">${d.category || ''} • ${d.language || ''}</p>
            <p><strong>Дата:</strong> ${escapeHtml(d.date || '')} ${d.time ? `• ${escapeHtml(d.time)}` : ''}</p>
            ${d.location ? `<p><strong>Місце:</strong> ${escapeHtml(d.location)}</p>` : ''}
            ${d.details ? `<p>${escapeHtml(d.details)}</p>` : ''}
          </section>
        `
      }

      function label(cat) {
        const map = {news:'Новини', spiritual:'Духовність', community:'Спільнота'}
        return map[cat] || (cat || '')
      }
      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
      }
    </script>
  </body>
</html>


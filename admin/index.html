<!DOCTYPE html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UGCC Lausanne Admin</title>
    <!-- Explicit favicon for project Pages so browser doesn't request domain root /favicon.ico -->
    <link rel="icon" href="/ugcc-site/favicon.ico" sizes="any">
    <link rel="icon" href="/ugcc-site/assets/images/favicon.svg" type="image/svg+xml">
  </head>
  <body>
    <div id="nc-root"></div>
    <script>
      // Purge any stale Netlify Identity hints that can force Netlify OAuth
      try {
        const purgeKeys = (store) => {
          const toDelete = [];
          for (let i = 0; i < store.length; i++) {
            const k = store.key(i);
            if (!k) continue;
            const kl = k.toLowerCase();
            if (kl.includes('netlify')) toDelete.push(k);
            if (kl.includes('site_id')) toDelete.push(k);
          }
          toDelete.forEach((k) => store.removeItem(k));
        };
        purgeKeys(window.localStorage);
        purgeKeys(window.sessionStorage);
      } catch (e) {}
      // Remove any site_id from URL if present
      try {
        const url = new URL(window.location.href);
        if (url.searchParams.has('site_id')) {
          url.searchParams.delete('site_id');
          history.replaceState({}, '', url.toString());
        }
      } catch (e) {}
    </script>
    <script>
      // Force manual init to avoid any fallback to Netlify OAuth
      window.CMS_MANUAL_INIT = true;
    </script>
    <!-- Decap CMS (>=3.4 has GitHub App implicit flow) -->
    <script src="https://unpkg.com/decap-cms@^3.5.0/dist/decap-cms.js"></script>
    <script>
      (function () {
        // Same config as admin/config.yml but inline, to guarantee GitHub App auth
        const urlNow = new URL(window.location.href);
        const config = {
          backend: {
            name: 'github',
            repo: 'ugcclausanne/ugcc-site',
            branch: 'main',
            auth_type: 'implicit',
            app_id: 2144987
          },
          publish_mode: 'editorial_workflow',
          media_folder: 'assets/uploads',
          public_folder: '/ugcc-site/assets/uploads',
          collections: [
            {
              name: 'articles',
              label: 'Articles',
              folder: 'data/articles',
              create: true,
              format: 'json',
              extension: 'json',
              slug: '{{year}}{{month}}{{day}}-{{slug}}',
              fields: [
                { label: 'Date/Time', name: 'timestamp', widget: 'datetime', format: 'YYYY-MM-DD HH:mm:ss' },
                { label: 'Email', name: 'email', widget: 'string', required: false },
                { label: 'Title', name: 'title', widget: 'string' },
                { label: 'Excerpt', name: 'excerpt', widget: 'text', required: false },
                { label: 'Category', name: 'category', widget: 'select', options: ['news', 'spiritual', 'community'] },
                { label: 'Language', name: 'language', widget: 'select', options: ['uk', 'en', 'fr'], default: 'uk' },
                { label: 'Image', name: 'image', widget: 'image', required: false },
                { label: 'Content', name: 'content', widget: 'text' },
                { label: 'Author', name: 'author', widget: 'string', required: false }
              ]
            },
            {
              name: 'schedule',
              label: 'Schedule',
              folder: 'data/schedule',
              create: true,
              format: 'json',
              extension: 'json',
              slug: '{{date}}-{{slug}}',
              fields: [
                { label: 'Timestamp', name: 'timestamp', widget: 'datetime', format: 'YYYY-MM-DD HH:mm:ss' },
                { label: 'Date', name: 'date', widget: 'date', required: false },
                { label: 'Time', name: 'time', widget: 'string', required: false },
                { label: 'Category', name: 'category', widget: 'select', options: ['liturgy', 'announcement'] },
                { label: 'Title', name: 'title', widget: 'string' },
                { label: 'Details', name: 'details', widget: 'text', required: false },
                { label: 'Location', name: 'location', widget: 'string', required: false },
                { label: 'Language', name: 'language', widget: 'select', options: ['uk', 'en', 'fr'], default: 'uk' },
                { label: 'Before Time', name: 'before_time', widget: 'string', required: false },
                { label: 'Before Details', name: 'before_details', widget: 'string', required: false },
                { label: 'After Details', name: 'after_details', widget: 'string', required: false },
                { label: 'After Time', name: 'after_time', widget: 'string', required: false },
                { label: 'Image', name: 'image', widget: 'image', required: false },
                { label: 'Link', name: 'link', widget: 'string', required: false }
              ]
            }
          ]
        };

        // Expose quick debug helper
        window.__cms_dbg = () => {
          try {
            const cfg = (window.CMS && window.CMS.getConfig) ? window.CMS.getConfig().toJS() : config;
            console.log('Manual init ON, backend:', cfg.backend && cfg.backend.name, 'auth_type:', cfg.backend && cfg.backend.auth_type);
            console.log('Collections:', (cfg.collections||[]).map(c=>c.name));
          } catch (e) { console.log('dbg error', e); }
        };

        function boot() {
          if (window.CMS && typeof window.CMS.init === 'function') {
            window.CMS.init({ load_config_file: true });
            // Re-log resolved config shortly after init
            setTimeout(() => { try { window.__cms_dbg(); } catch (_) {} }, 200);
          } else {
            // Retry in case the script hasn't loaded yet
            setTimeout(boot, 50);
          }
        }
        boot();
      })();
    </script>
  </body>
  </html>

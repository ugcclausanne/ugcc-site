<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
  </head>
  <body>
    <!-- Sveltia CMS (drop-in replacement for Decap) -->
    <div id="sveltia-cms-root"></div>
    <!-- Sveltia UMD bundle (official dist) -->
    <script src="https://unpkg.com/@sveltia/cms/dist/sveltia-cms.js"></script>
    <!-- Sveltia CMS admin -->
    <div id="sveltia-root"></div>
    <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        // Purge Netlify/old keys that cause wrong auth proxy
        try {
          const purgeKeys = (store) => {
            const toDelete = [];
            for (let i = 0; i < store.length; i++) {
              const k = store.key(i);
              if (!k) continue;
              const kl = k.toLowerCase();
              if (kl.includes('netlify') || kl.includes('site_id')) toDelete.push(k);
            }
            toDelete.forEach((k) => store.removeItem(k));
          };
          purgeKeys(window.localStorage);
          purgeKeys(window.sessionStorage);
        } catch (e) { console.warn('storage purge failed', e); }

        async function loadConfigAndInit() {
          try {
            const res = await fetch('/admin/config.yml');
            if (!res.ok) throw new Error('config.yml not found');
            const text = await res.text();
            const cfg = jsyaml.load(text);
            // Wait until a Sveltia initializer is available. Different bundle builds
            // expose either a global `CMS` default export, a global `init` helper,
            // or (older code) `SveltiaCMS`. Accept any of those.
            const initWhenReady = () => {
              const tryInit = () => {
                try {
                  if (window.CMS && typeof window.CMS.init === 'function') {
                    console.log('detected global: CMS');
                    window.CMS.init(cfg);
                    return true;
                  }
                  if (typeof window.init === 'function') {
                    console.log('detected global: init');
                    window.init(cfg);
                    return true;
                  }
                  if (window.SveltiaCMS && typeof window.SveltiaCMS.init === 'function') {
                    console.log('detected global: SveltiaCMS');
                    window.SveltiaCMS.init(cfg);
                    return true;
                  }
                } catch (e) {
                  console.error('Sveltia init error', e);
                  return true; // stop retrying on thrown init errors
                }
                return false;
              };

              if (!tryInit()) setTimeout(initWhenReady, 50);
            };
            initWhenReady();
          } catch (e) {
            console.error('Failed to load or parse admin/config.yml', e);
          }
        }

        loadConfigAndInit();
    </script>
  </body>
</html>
